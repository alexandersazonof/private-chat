<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Chat</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="css/chat.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">


    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>

</head>
<body>
<div id="general">

</div>
<script>

    $( document ).ready(function() {

        // check token load chat or login html code
        checkToken();

        // after click on sign up , appears registration form
        $('body').on('click', '#btn-view-signup', function () {

            getRegistrationPage();
        });

        // after click on login , appears login form
        $('body').on('click', '#btn-view-login',function () {
            getLoginPage();
        });

        // registration logic, after success appears login form
        $('body').on('click', '#btn-signup', function () {
           if (signup()) {
               successAlert("User was successful created");
               getLoginPage();
           }
        });

        $("body").on('click', 'li', function () {
            var id = $(this).find('.chatId').val();
            console.log("click li: " + id);
            getChatInfo(id);
        });

        // login logic, after success appears chat and token save in cookie
        $("body").on('click', '#btn-login', function () {
            var json = login();

            if (json != null) {
                successAlert("Success sign in");

                checkToken();

                var token = json.response.token;
                var id = json.response.id;

                localStorage.setItem("id", id);
                Cookies.set("token", token);
                checkToken();
            }
        });

        $('body').on('click', '#logout', function () {
            Cookies.remove('token');
            checkToken();
        })
    });


    // login request
    function login() {
        var xhr = new XMLHttpRequest();
        var login = document.getElementById('login').value;
        var password  = document.getElementById("password").value;

        var json = JSON.stringify({
            login: login,
            password: password
        });

        xhr.open('POST', 'http://10.6.103.13:8000/api/v1/auth/signin', false);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(json);

        if (xhr.status != 200) {

            var mes = JSON.parse(xhr.responseText).message;

            dangerAlert(mes);

            return null;
        } else {
            var json = JSON.parse(xhr.responseText);

            return json;
        }
    }


    // signup request
    function signup() {
        var xhr = new XMLHttpRequest();
        var login = document.getElementById('login').value;
        var password  = document.getElementById("password").value;
        var passwordConfirm = document.getElementById("passwordConfirm").value;
        var name = document.getElementById("name").value;


        var json = JSON.stringify({
            login: login,
            password: password,
            passwordConfirm: passwordConfirm,
            name: name
        });

        xhr.open('POST', 'http://10.6.103.13:8000/api/v1/auth/signup', false);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(json);

        if (xhr.status != 200) {
            var mes = JSON.parse(xhr.responseText).message;

            dangerAlert(mes);
            return false;
        } else {
            return true;
        }
    }

    // login html code
    function getLoginPage() {
        $("#general").replaceWith('<div id="general">\n' +
            '    <div class="row my-5">\n' +
            '        <div class="col-md-4"></div>\n' +
            '        <div class="col-md-2">\n' +
            '            <h4 class="text-center">Sign in</h4>\n' +
            '            <form name="user" >\n' +
            '                <label>Login</label>\n' +
            '                <input type="text" class="form-control" name="login" id="login" value="user">\n' +
            '                <label>Password</label>\n' +
            '                <input type="password" class="form-control" name="password" id="password" value="password">\n' +
            '\n' +
            '            </form>\n' +
            '            <button id="btn-login" class="btn btn-light my-3">Submit</button>\n' +
            '            <button id="btn-view-signup" class="btn btn-primary my-1">Sign up</button>\n' +
            '        </div>\n' +
            '    </div>\n' +
            '</div>');
    }


    // registration html code
    function getRegistrationPage() {
        $("#general").replaceWith('<div id="general">\n' +
            '    <div class="row my-5">\n' +
            '        <div class="col-md-4"></div>\n' +
            '        <div class="col-md-2">\n' +
            '            <h4 class="text-center">Sign up</h4>\n' +
            '            <form name="user" >\n' +
            '                <label>Login</label>\n' +
            '                <input type="text" class="form-control" id="login">\n' +
            '                <label>Password</label>\n' +
            '                <input type="password" class="form-control"  id="password">\n' +
            '                <label>Password confirm</label>\n' +
            '                <input type="password" class="form-control"  id="passwordConfirm" >\n' +
            '                <label>Name</label>\n' +
            '                <input type="text" class="form-control"  id="name">\n' +
            '            </form>\n' +
            '            <button id="btn-signup" class="btn btn-light my-3">Submit</button>\n' +
            '            <button id="btn-view-login" class="btn btn-primary my-1">Login</button>\n' +
            '        </div>\n' +
            '    </div>\n' +
            '</div>');
    }

    // danger alert html code
    function dangerAlert(data) {
        $("<div class=\"alert alert-danger alert-dismissible fade show\" role=\"alert\">\n" +
            "  <strong>"+ data + "</strong>\n" +
            "  <button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\">\n" +
            "    <span aria-hidden=\"true\">&times;</span>\n" +
            "  </button>\n" +
            "</div>").prependTo('body');
    }

    // success alert html code
    function successAlert(data) {
        $("<div class=\"alert alert-success alert-dismissible fade show\" role=\"alert\">\n" +
            "  <strong>"+ data + "</strong>\n" +
            "  <button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\">\n" +
            "    <span aria-hidden=\"true\">&times;</span>\n" +
            "  </button>\n" +
            "</div>").prependTo('body');
    }

    function viewMessages(json) {

        var messages = json.response.messages;
        var id_array = [];
        var name_array = [];

        var general = "<div class=\"col-md-8 col-xl-6 chat\" id=\"message\">\n" +
            "                <div class=\"card\">\n" +
            "                    <div class=\"card-header msg_head\">\n" +
            "                        <div class=\"d-flex bd-highlight\">\n" +
            "                            <div class=\"img_cont\">\n" +
            "                                <canvas id='main-chat-photo' class=\"rounded-circle user_img\"> </canvas>\n" +

            "                            </div>\n" +
            "                            <div class=\"user_info\">\n" +
            "                                <span>"+ json.response.messages[0].chat.name +"</span>\n" +
            "                                <p>1767 Messages</p>\n" +
            "                            </div>\n" +
            "                            <div class=\"video_cam\">\n" +
            "                                <span><i class=\"fas fa-video\"></i></span>\n" +
            "                                <span><i class=\"fas fa-phone\"></i></span>\n" +
            "                            </div>\n" +
            "                        </div>\n" +
            "                        <span id=\"action_menu_btn\"><i class=\"fas fa-ellipsis-v\"></i></span>\n" +
            "                        <div class=\"action_menu\">\n" +
            "                            <ul>\n" +
            "                                <li><i class=\"fas fa-user-circle\"></i> View profile</li>\n" +
            "                                <li><i class=\"fas fa-users\"></i> Add to close friends</li>\n" +
            "                                <li><i class=\"fas fa-plus\"></i> Add to group</li>\n" +
            "                                <li><i class=\"fas fa-ban\"></i> Block</li>\n" +
            "                            </ul>\n" +
            "                        </div>\n" +
            "                    </div>\n" +
            "                    <div class=\"card-body msg_card_body\">";




        for (var i = 0; i < messages.length; i++) {
            var temp = "";
            var userId = localStorage.getItem("id");
            var date = new Date(messages[i].date);
            var value = messages[i].value ;

            id_array.push(messages[i].id);

            name_array.push(messages[i].user.name.charAt(0));

            if(messages[i].user.id != userId) {

                temp += "<div class=\"d-flex justify-content-start mb-4\" id='message-'" + messages[i].id +">\n" +
                    "                            <div class=\"img_cont_msg\">\n" +
                    "                                <canvas class='rounded-circle user_img_msg' id='message-photo-" +messages[i].id  + "'> </canvas>\n" +
                    "                            </div>\n" +
                    "                            <div class=\"msg_cotainer\">\n" +
                      value +
                    "                                <span class=\"msg_time\">" + date.toDateString() + "</span>\n" +
                    "                            </div>\n" +
                    "                        </div>";
            } else {

                temp += "<div class=\"d-flex justify-content-end mb-4\" id='message-'" + messages[i].id +">\n" +
                    "                <div class=\"msg_cotainer_send\">\n" +
                    value +
                    "                    <span class=\"msg_time_send\">" + date.toDateString() + "</span>\n" +
                    "                </div>\n" +
                    "                <div class=\"img_cont_msg\">\n" +
                    "                    <canvas class='rounded-circle user_img_msg' id='message-photo-" + messages[i].id  + "'> </canvas>\n" +
                    "                </div>\n" +
                    "            </div>";
            }



            general += temp;
        }


        general += "</div>\n" +
            "        <div class=\"card-footer\">\n" +
            "            <div class=\"input-group\">\n" +
            "                <div class=\"input-group-append\">\n" +
            "                    <span class=\"input-group-text attach_btn\"><i class=\"fas fa-paperclip\"></i></span>\n" +
            "                </div>\n" +
            "                <textarea name=\"\" class=\"form-control type_msg\" placeholder=\"Type your message...\"></textarea>\n" +
            "                <div class=\"input-group-append\">\n" +
            "                    <span class=\"input-group-text send_btn\"><i class=\"fas fa-location-arrow\"></i></span>\n" +
            "                </div>\n" +
            "            </div>\n" +
            "        </div>\n" +
            "    </div>\n" +
            "</div>";

        $("#message").replaceWith(general);

        for(var i = 0;i<name_array.length;i++) {
            drawIcon("message-photo-" + id_array[i], name_array[i]);
        }
        drawIcon("main-chat-photo", json.response.messages[0].chat.name.charAt(0));
    }

    function checkToken() {
        var xhr = new XMLHttpRequest();

        var token = Cookies.get('token');
        var id = localStorage.getItem("id");
        var url = 'http://10.6.103.13:8000/api/v1/chats';
        var param = 'userId=' + id;



        xhr.open('GET', url + "?" + param, true);
        xhr.setRequestHeader('Authorization', 'Bearer ' + token);



        xhr.send();

        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
                if(xhr.status != 200) {
                    getLoginPage();
                    return false;
                } else {


                    var json = JSON.parse(xhr.responseText);
                    chat(json);
                }
            }
        };
    }

    function getChatInfo(id) {
        var xhr = new XMLHttpRequest();

        var token = Cookies.get('token');
        var url = 'http://10.6.103.13:8000/api/v1/chats/' + id + "/messages/";
        xhr.open('GET', url, true);
        xhr.setRequestHeader('Authorization', 'Bearer ' + token);

        xhr.send();

        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
                if(xhr.status != 200) {
                    //getLoginPage();
                    return false;
                } else {

                    var json = JSON.parse(xhr.responseText);
                    viewMessages(json);
                }
            }
        };
    }

    function chat(json) {

        var chat_li = "";
        var id_array = [];
        var name_array = [];

        for (var i = 0 ; i < json.response.chats.length ; i++) {
            var name = json.response.chats[i].name;
            var id = json.response.chats[i].id;

            id_array.push(id);
            name_array.push(name.charAt(0));

            var li = "<li>\n" +
                "                            <div class=\"d-flex bd-highlight\">\n" +
                "                                <div class=\"img_cont\">\n" +
                     "<canvas class='rounded-circle user_img' id='chat-"+ id + "'></canvas> "+
                "                                </div>\n" +
                "                                <div class=\"user_info\">\n" +
                "                                    <span class='chatName'>" + name + "</span>\n" +
                     "<input type='hidden' class='chatId' value=' " + id + "'>"  +
                "                                    <p>Offline</p>\n" +
                "                                </div>\n" +
                "                            </div>\n" +
                "                        </li>";

            chat_li += li;
        }



        $("#general").replaceWith("<div id=\"general\">\n" +
            "    <div class=\"container-fluid h-100\">\n" +
            "        <div class=\"row justify-content-center h-100\">\n" +
            "            <div class=\"col-md-4 col-xl-3 chat\"><div class=\"card mb-sm-3 mb-md-0 contacts_card\">\n" +
            "                <div class=\"card-header\">\n" +
            "                    <div class=\"input-group\">\n" +
            "                        <input type=\"text\" placeholder=\"Search...\" name=\"\" class=\"form-control search\">\n" +
            "                        <div class=\"input-group-prepend\">\n" +
            "                            <span class=\"input-group-text search_btn\"><i class=\"fas fa-search\"></i></span>\n" +
            "                        </div>\n" +
            "<a id='logout'> <i class=\"fas fa-sign-out-alt my-1 ml-3 h4\" id='my-icon'></i> </a>"+
            "<a id='create-chat'><i class=\"fas fa-plus  my-1 ml-3 h4\"></i></a>"+
            "                    </div>\n" +
            "                </div>\n" +
            "                <div class=\"card-body contacts_body\">\n" +
            "                    <ui class=\"contacts\">\n" +
            chat_li +
            "                    </ui>\n" +
            "                </div>\n" +
            "                <div class=\"card-footer\"></div>\n" +
            "            </div></div>\n" +
            "            <div id=\"message\">\n" +

            "            </div>\n" +
            "        </div>\n" +
            "    </div>\n" +
            "</div>");

        for (var i =0;i<id_array.length;i++) {
            drawIcon("chat-" + id_array[i], name_array[i]);
        }
    }
    
    function drawIcon(id, text) {
        const canvas = document.getElementById(id);
        canvas.width = 64;
        canvas.height = 64;
        const context = canvas.getContext("2d");
        // Draw background
        context.fillStyle = getRandomColor();
        context.fillRect(0, 0, canvas.width, canvas.height);
        // Draw text
        context.fillStyle = "#FFFFFF";
        context.font = "30px Helvetica";
        context.textBaseline = "middle";
        context.textAlign = "center";
        const x = canvas.width / 2;
        const y = canvas.height / 2;
        context.fillText(text, x, y);
    }

    function getRandomColor() {
        var letters = '0123456789ABCDEF';
        var color = '#';
        for (var i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

</script>

</body>
</html>