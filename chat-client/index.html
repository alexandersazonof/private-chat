<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Chat</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="css/chat.css">

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
</head>
<body>
<div id="general">

</div>

<script>

    $( document ).ready(function() {

        // check token load chat or login html code
        checkToken();

        // after click on sign up , appears registration form
        $('body').on('click', '#btn-view-signup', function () {

            getRegistrationPage();
        });

        // after click on login , appears login form
        $('body').on('click', '#btn-view-login',function () {
            getLoginPage();
        });

        // registration logic, after success appears login form
        $('body').on('click', '#btn-signup', function () {
           if (signup()) {
               successAlert("User was successful created");
               getLoginPage();
           }
        });

        // login logic, after success appears chat and token save in cookie
        $("body").on('click', '#btn-login', function () {
            var json = login();

            if (json != null) {
                successAlert("Success sign in");

                checkToken();

                var token = json.response.token;
                var id = json.response.id;

                localStorage.setItem("id", id);
                Cookies.set("token", token);
            }
        })
    });


    // login request
    function login() {
        var xhr = new XMLHttpRequest();
        var login = document.getElementById('login').value;
        var password  = document.getElementById("password").value;

        var json = JSON.stringify({
            login: login,
            password: password
        });

        xhr.open('POST', 'https://localhost:8000/api/v1/auth/signin', false);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(json);

        if (xhr.status != 200) {

            var mes = JSON.parse(xhr.responseText).message;

            dangerAlert(mes);

            return null;
        } else {
            var json = JSON.parse(xhr.responseText);

            return json;
        }
    }


    // signup request
    function signup() {
        var xhr = new XMLHttpRequest();
        var login = document.getElementById('login').value;
        var password  = document.getElementById("password").value;
        var passwordConfirm = document.getElementById("passwordConfirm").value;
        var name = document.getElementById("name").value;


        var json = JSON.stringify({
            login: login,
            password: password,
            passwordConfirm: passwordConfirm,
            name: name
        });

        xhr.open('POST', 'https://localhost:8000/api/v1/auth/signup', false);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(json);

        if (xhr.status != 200) {
            var mes = JSON.parse(xhr.responseText).message;

            dangerAlert(mes);
            return false;
        } else {
            return true;
        }
    }

    // login html code
    function getLoginPage() {
        $("#general").replaceWith('<div id="general">\n' +
            '    <div class="row my-5">\n' +
            '        <div class="col-md-4"></div>\n' +
            '        <div class="col-md-2">\n' +
            '            <h4 class="text-center">Sign in</h4>\n' +
            '            <form name="user" >\n' +
            '                <label>Login</label>\n' +
            '                <input type="text" class="form-control" name="login" id="login" value="user">\n' +
            '                <label>Password</label>\n' +
            '                <input type="password" class="form-control" name="password" id="password" value="password">\n' +
            '\n' +
            '            </form>\n' +
            '            <button id="btn-login" class="btn btn-light my-3">Submit</button>\n' +
            '            <button id="btn-view-signup" class="btn btn-primary my-1">Sign up</button>\n' +
            '        </div>\n' +
            '    </div>\n' +
            '</div>');
    }


    // registration html code
    function getRegistrationPage() {
        $("#general").replaceWith('<div id="general">\n' +
            '    <div class="row my-5">\n' +
            '        <div class="col-md-4"></div>\n' +
            '        <div class="col-md-2">\n' +
            '            <h4 class="text-center">Sign up</h4>\n' +
            '            <form name="user" >\n' +
            '                <label>Login</label>\n' +
            '                <input type="text" class="form-control" id="login">\n' +
            '                <label>Password</label>\n' +
            '                <input type="password" class="form-control"  id="password">\n' +
            '                <label>Password confirm</label>\n' +
            '                <input type="password" class="form-control"  id="passwordConfirm" >\n' +
            '                <label>Name</label>\n' +
            '                <input type="text" class="form-control"  id="name">\n' +
            '            </form>\n' +
            '            <button id="btn-signup" class="btn btn-light my-3">Submit</button>\n' +
            '            <button id="btn-view-login" class="btn btn-primary my-1">Login</button>\n' +
            '        </div>\n' +
            '    </div>\n' +
            '</div>');
    }

    // danger alert html code
    function dangerAlert(data) {
        $("<div class=\"alert alert-danger alert-dismissible fade show\" role=\"alert\">\n" +
            "  <strong>"+ data + "</strong>\n" +
            "  <button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\">\n" +
            "    <span aria-hidden=\"true\">&times;</span>\n" +
            "  </button>\n" +
            "</div>").prependTo('body');
    }

    // success alert html code
    function successAlert(data) {
        $("<div class=\"alert alert-success alert-dismissible fade show\" role=\"alert\">\n" +
            "  <strong>"+ data + "</strong>\n" +
            "  <button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\">\n" +
            "    <span aria-hidden=\"true\">&times;</span>\n" +
            "  </button>\n" +
            "</div>").prependTo('body');
    }

    function checkToken() {
        var xhr = new XMLHttpRequest();

        var token = Cookies.get('token');
        var id = localStorage.getItem("id");
        var url = 'https://localhost:8000/api/v1/chats';
        var param = 'userId=' + id;



        xhr.open('GET', url + "?" + param, true);
        xhr.setRequestHeader('Authorization', 'Bearer ' + token);



        xhr.send();

        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
                if(xhr.status != 200) {
                    getLoginPage();
                    return false;
                } else {


                    var json = JSON.parse(xhr.responseText);
                    chat(json);
                }
            }
        };
    }

    function chat(json) {
        $("#general").replaceWith("<div id='general'></div>");
    }

</script>

</body>
</html>